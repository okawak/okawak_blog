name: Deploy Obsidian to S3

on:
  schedule:
    - cron: "0 0 * * *" # æ¯Žæ—¥00:00 UTC
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

env:
  RUST_BACKTRACE: 1
  UPLOAD_PATH: crates/obsidian_uploader/dist

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Get App Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: >-
            okawak_blog,
            obsidian

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          submodules: recursive # submoduleå–å¾—
          fetch-depth: 1

      - name: Update submodules
        run: |
          set -e
          echo "ðŸ“¦ Syncing submodules..."
          git submodule sync --recursive
          echo "ðŸ”„ Updating submodules to latest..."
          git submodule update --recursive --remote
          echo "âœ… Submodules updated successfully"

      - name: Install OpenSSL and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install pkg-config libssl-dev

      - name: Cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Test obsidian_uploader
        run: |
          echo "ðŸ§ª Running tests for obsidian_uploader..."
          cargo test -p obsidian_uploader --verbose
          echo "âœ… All tests passed successfully"

      - name: Build obsidian_uploader
        run: |
          echo "ðŸ”¨ Building obsidian_uploader in release mode..."
          cargo build --release -p obsidian_uploader
          echo "âœ… Build completed successfully"

      - name: Run obsidian_uploader
        run: |
          echo "ðŸš€ Running obsidian_uploader..."
          start_time=$(date +%s)
          RUST_LOG=info cargo run --release -p obsidian_uploader
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "â±ï¸  Processing completed in ${duration} seconds"
          
          # å‡¦ç†çµæžœã®æ¤œè¨¼
          if [ -d "crates/obsidian_uploader/dist" ]; then
            file_count=$(find crates/obsidian_uploader/dist -name "*.html" | wc -l)
            echo "ðŸ“„ Generated ${file_count} HTML files"
            if [ "$file_count" -eq 0 ]; then
              echo "âš ï¸  Warning: No HTML files were generated"
            fi
          else
            echo "âŒ Output directory not found"
            exit 1
          fi

      - name: Validate AWS secrets
        run: |
          if [ -z "${{ secrets.AWS_REGION }}" ] || [ -z "${{ secrets.AWS_ACCOUNT_ID }}" ] || [ -z "${{ secrets.AWS_ROLE_NAME }}" ] || [ -z "${{ secrets.S3_BUCKET }}" ]; then
            echo "Error: Required AWS secrets are missing"
            echo "Required: AWS_REGION, AWS_ACCOUNT_ID, AWS_ROLE_NAME, S3_BUCKET"
            exit 1
          fi
          echo "âœ… All required AWS secrets are present"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_ROLE_NAME }}

      - name: Sync to S3
        run: |
          echo "â˜ï¸  Starting S3 sync..."
          sync_start=$(date +%s)
          
          # S3åŒæœŸã‚’å®Ÿè¡Œã—ã€çµæžœã‚’è¨˜éŒ²
          aws s3 sync ${{ env.UPLOAD_PATH }} s3://${{ secrets.S3_BUCKET }} \
            --delete \
            --content-type "text/html; charset=utf-8" \
            --cache-control "public, max-age=300" \
            --output json > s3_sync_result.json
          
          sync_end=$(date +%s)
          sync_duration=$((sync_end - sync_start))
          echo "â±ï¸  S3 sync completed in ${sync_duration} seconds"
          
          # åŒæœŸçµæžœã®æ¤œè¨¼
          uploaded_count=$(find ${{ env.UPLOAD_PATH }} -name "*.html" | wc -l)
          echo "ðŸ“¤ Uploaded ${uploaded_count} files to S3"
          
          # S3ãƒã‚±ãƒƒãƒˆã®å†…å®¹ç¢ºèª
          s3_object_count=$(aws s3 ls s3://${{ secrets.S3_BUCKET }}/ --recursive | grep ".html" | wc -l)
          echo "ðŸª£ S3 bucket now contains ${s3_object_count} HTML files"

      - name: Output deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Processing Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Files processed**: $(find ${{ env.UPLOAD_PATH }} -name '*.html' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket**: \`${{ secrets.S3_BUCKET }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… S3 sync completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Total workflow time**: ${{ job.deploy.duration || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Troubleshooting" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for detailed error information." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Common issues:" >> $GITHUB_STEP_SUMMARY
          echo "- Submodule update failures" >> $GITHUB_STEP_SUMMARY
          echo "- AWS credentials or permissions" >> $GITHUB_STEP_SUMMARY
          echo "- Build or test failures" >> $GITHUB_STEP_SUMMARY
          echo "- S3 sync issues" >> $GITHUB_STEP_SUMMARY
