---
title: RustのMapはとりあえず IndexMap を使用すればいい #データ構造 - Qiita
source: https://qiita.com/lucidfrontier45/items/cfaec141a45f4fc1480a
---

[![](https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65444%2Fprofile-images%2F1661216948?ixlib=rb-4.0.0&auto=compress%2Cformat&lossless=0&w=48&s=69531d36dd8b3d99137a7768a01763f0)](https://qiita.com/lucidfrontier45)

@lucidfrontier45(杜世橋)

# RustのMapはとりあえず IndexMap を使用すればいい

- [Rust](https://qiita.com/tags/rust)
- [HashMap](https://qiita.com/tags/hashmap)
- [データ構造](https://qiita.com/tags/%e3%83%87%e3%83%bc%e3%82%bf%e6%a7%8b%e9%80%a0)
- [TreeMap](https://qiita.com/tags/treemap)

最終更新日 2025年08月20日投稿日 2025年08月18日# **背景

Rustで辞書型のデータ構造を扱う際には`HashMap`と`BTreeMap`の二種類があってどちらを使うかよく悩みますよね。私は今まではよく`BTreeMap`のほうを使用していました。確かに`HashMap`のほうが多くの操作がO(1)で`BTreeMap`のO(logN)よりも理論上は速いのですが、Nがそこまで大きくない場合にはあまり有意な差は出ず、むしろキーの順番がランダムに変わるということで、すべての要素に対して処理を行う際にソートを忘れると結果の再現性に影響が出る場合がありました。

[![image.png](https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65444%2Fceddf350-e3d5-4425-9c4f-a32c3816827c.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=6b5e7ec370bb4978eb3212a3ef4725bf)](https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65444%2Fceddf350-e3d5-4425-9c4f-a32c3816827c.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=6b5e7ec370bb4978eb3212a3ef4725bf)<br>図は筆者が社内勉強会で作成したスライドより

一方で`BTreeMap`のほうにも問題があって、CodeLLDBなどのデバッガーで見たときに全くHuman-Readableではないというものです。

[![image.png](https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65444%2Feda4a626-f6c3-417f-a604-eb95c3c9cbd7.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=612b09e9256271ac2d14a105fd6b7f28)](https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65444%2Feda4a626-f6c3-417f-a604-eb95c3c9cbd7.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=612b09e9256271ac2d14a105fd6b7f28)



# **本題

結論: `IndexMap`1 を使う。

`IndexMap`はRDBなどのようにデータ自体を連続な配列で保持し、それとは別に検索用のインデックスをHashTableで持っておくというデータ構造です。連続な配列はRustの標準ライブラリの`Vec`をそのまま使用していますのでCodeLLDBでもちゃんと読める形で表示されますし、

[![image.png](https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65444%2F125c0d89-7c6b-4500-94fd-3a147585ef85.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=9da32594ecc4072965f7e891e0858e3e)](https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65444%2F125c0d89-7c6b-4500-94fd-3a147585ef85.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=9da32594ecc4072965f7e891e0858e3e)

すべての要素に対して走査する場合もインサートした順なので同じ条件であれば必ず同じ結果になります。

[![image.png](https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65444%2F88923db0-9d75-4476-9b8d-d4c18fb4575b.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=55619e5a73f9c471ebee468ae3173be5)](https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65444%2F88923db0-9d75-4476-9b8d-d4c18fb4575b.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=55619e5a73f9c471ebee468ae3173be5)

あとは細かい話ですが、RustのデフォルトのHasherはセキュリティを重視していてパフォーマンスがあまりよくないので、計算系のプログラムの場合には上記のコードのように`FxBuildHasher`などの高速なものを代わりに使用することをお勧めします。



# **結論

以下に各種Mapをまとめました。基本はIndexMapあるいはFxIndexMapを使用し、範囲検索が必要な場合だけBTreeMapを使用すればいいと思います。

|  | **HashMap** | **BTreeMap** | **IndexMap** | **FxIndexMap** |  |
| **Computational Complexity** | O(1) | O(logN) | O(1) | O(1) |  |
| **Overhead** | Hash function needs unignorable overhead | Smaller | Hash function needs unignorable overhead | Smaller |  |
| **Data Order** | Stochastic | Sorted by key | Deterministic | Deterministic |  |
| **Range Search** | No | Yes | No | No |  |
| **Iteration for all elements** | Slower | Faster | Faster | Faster |  |
| **Debugging** | Easy | Difficult | Easy | Easy |  |


1. [https://github.com/indexmap-rs/indexmap](https://github.com/indexmap-rs/indexmap)↩

[19](https://qiita.com/lucidfrontier45/items/cfaec141a45f4fc1480a/likers)いいねしたユーザー一覧へ移動

12comment0コメント一覧へ移動

新規登録して、もっと便利にQiitaを使ってみよう

1. あなたにマッチした記事をお届けします
1. 便利な情報をあとで効率的に読み返せます
1. ダークテーマを利用できます

[ログインすると使える機能について](https://help.qiita.com/ja/articles/qiita-login-user)[新規登録](https://qiita.com/signup?callback_action=login_or_signup&redirect_to=%2Flucidfrontier45%2Fitems%2Fcfaec141a45f4fc1480a&realm=qiita)[ログイン](https://qiita.com/login?callback_action=login_or_signup&redirect_to=%2Flucidfrontier45%2Fitems%2Fcfaec141a45f4fc1480a&realm=qiita)

